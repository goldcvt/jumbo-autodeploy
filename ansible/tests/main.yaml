---
- hosts: test-servers
  become: true

  tasks:
    - name: Pull MongoDB
      docker_image:
        name: "mongo:4.0"
        source: pull
        # pull:
        #   platform: amd64
    
    - name: Create directory for keyfile
      file:
        state: directory
        path: /home/coro/mongo-files/data
        # owner # = chown
        # mode # = chmod, starting with leading zero
    
    - name: Create keyfile
      shell: openssl rand -base64 741 > /home/coro/mongodb-keyfile
      
    - name: Chmod the keyfile
      shell: chmod 600 /home/coro/mongodb-keyfile
      
    - name: Change owner to Mongo-container user
      shell: chown 999 /home/coro/mongodb-keyfile
    
    - name: Create network
      docker_network:
        name: db-net
        attachable: yes
      
      # not running?
    - name: Init MongoDB master
      docker_container:
        state: started
        name: "MongoDB-master"
        image: "mongo:4.0"
        hostname: "mongo1.mongo-cluster"
        volumes:
          - /home/coro/mongo-files/data:/data/db
          - /home/coro:/opt/keyfile
        exposed_ports:
          - "27017:27017"
        detach: yes
        command: --smallfiles --oplogSize 128 --keyFile /opt/keyfile/mongodb-keyfile --replSet "rs0"
        networks:
          - name: db-net
        purge_networks: yes
      
      # does both locally and remotely??
    - name: Add Mongo container to inventory
      add_host:
        name: "MongoDB-master"
        ansible_connection: docker
      changed_when: false
        
#    - name: Run a sample docker command
#      raw: ls
#      delegate_to: "MongoDB-master"
      
    - name: Create admin user
      community.mongodb.mongodb_user:
        database: admin
        name: siteUserAdmin
        password: password #"{{ admin-password | mandatory }}"
        roles: userAdminAnyDatabase
        state: present
      delegate_to: "MongoDB-master"

    - name: Create root user
      community.mongodb.mongodb_user:
        database:
        name: siteRootAdmin
        password: p4ssw0rd #"{{ root-password | mandatory }}"
        roles: root
        state: present
      delegate_to: "MongoDB-master"
